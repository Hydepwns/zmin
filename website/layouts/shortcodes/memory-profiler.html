<!-- Memory Profiler Dashboard -->
<div class="memory-profiler">
    <h2>Memory Profiling Dashboard</h2>
    
    <!-- Memory Overview -->
    <div class="memory-section">
        <h3>Memory Usage Overview</h3>
        <div class="memory-stats">
            <div class="stat-card">
                <div class="stat-value" id="peak-memory">--</div>
                <div class="stat-label">Peak Memory (MB)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-memory">--</div>
                <div class="stat-label">Average Memory (MB)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="allocations">--</div>
                <div class="stat-label">Total Allocations</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="deallocations">--</div>
                <div class="stat-label">Total Deallocations</div>
            </div>
        </div>
    </div>
    
    <!-- Memory Timeline -->
    <div class="memory-section">
        <h3>Memory Usage Timeline</h3>
        <canvas id="memory-timeline" width="800" height="300"></canvas>
    </div>
    
    <!-- Allocation Patterns -->
    <div class="memory-section">
        <h3>Allocation Patterns</h3>
        <div class="allocation-grid">
            <div class="allocation-chart">
                <h4>Allocation Size Distribution</h4>
                <canvas id="allocation-sizes" width="350" height="250"></canvas>
            </div>
            <div class="allocation-chart">
                <h4>Allocation Types</h4>
                <canvas id="allocation-types" width="350" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Memory Heatmap -->
    <div class="memory-section">
        <h3>Memory Access Heatmap</h3>
        <div id="memory-heatmap" class="heatmap-container">
            <canvas id="heatmap-canvas" width="800" height="200"></canvas>
            <div class="heatmap-legend">
                <span class="legend-low">Low</span>
                <div class="legend-gradient"></div>
                <span class="legend-high">High</span>
            </div>
        </div>
    </div>
    
    <!-- Performance by Data Size -->
    <div class="memory-section">
        <h3>Memory Efficiency by Data Size</h3>
        <div id="memory-efficiency" class="efficiency-chart">
            <canvas id="efficiency-canvas" width="800" height="300"></canvas>
        </div>
    </div>
    
    <!-- Recommendations -->
    <div class="memory-section">
        <h3>Memory Optimization Recommendations</h3>
        <div id="recommendations" class="recommendations-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';
    
    // Simulated memory profiling data (would be loaded from CI artifacts)
    const memoryData = {
        peak_mb: 12.5,
        average_mb: 8.3,
        total_allocations: 15420,
        total_deallocations: 15420,
        timeline: generateTimeline(),
        allocation_sizes: {
            'small (<1KB)': 8500,
            'medium (1-10KB)': 5200,
            'large (10-100KB)': 1500,
            'huge (>100KB)': 220
        },
        allocation_types: {
            'JSON Tokens': 45,
            'String Buffers': 30,
            'Parse Stack': 15,
            'Output Buffer': 10
        },
        efficiency: [
            { size: '1KB', memory: 0.5 },
            { size: '10KB', memory: 1.2 },
            { size: '100KB', memory: 3.5 },
            { size: '1MB', memory: 8.3 },
            { size: '10MB', memory: 12.5 },
            { size: '100MB', memory: 18.7 },
            { size: '1GB', memory: 45.2 }
        ]
    };
    
    function generateTimeline() {
        const points = 100;
        const data = [];
        let current = 2;
        
        for (let i = 0; i < points; i++) {
            // Simulate memory usage pattern
            current += (Math.random() - 0.3) * 2;
            current = Math.max(0, Math.min(current, 15));
            
            data.push({
                time: i * 10, // milliseconds
                memory: current
            });
        }
        
        return data;
    }
    
    function initMemoryProfiler() {
        updateStats();
        drawTimeline();
        drawAllocationSizes();
        drawAllocationTypes();
        drawHeatmap();
        drawEfficiencyChart();
        generateRecommendations();
    }
    
    function updateStats() {
        document.getElementById('peak-memory').textContent = memoryData.peak_mb.toFixed(1);
        document.getElementById('avg-memory').textContent = memoryData.average_mb.toFixed(1);
        document.getElementById('allocations').textContent = memoryData.total_allocations.toLocaleString();
        document.getElementById('deallocations').textContent = memoryData.total_deallocations.toLocaleString();
    }
    
    function drawTimeline() {
        const ctx = document.getElementById('memory-timeline').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: memoryData.timeline.map(d => d.time + 'ms'),
                datasets: [{
                    label: 'Memory Usage (MB)',
                    data: memoryData.timeline.map(d => d.memory),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Memory (MB)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function drawAllocationSizes() {
        const ctx = document.getElementById('allocation-sizes').getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(memoryData.allocation_sizes),
                datasets: [{
                    data: Object.values(memoryData.allocation_sizes),
                    backgroundColor: [
                        'rgb(54, 162, 235)',
                        'rgb(75, 192, 192)',
                        'rgb(255, 205, 86)',
                        'rgb(255, 99, 132)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });
    }
    
    function drawAllocationTypes() {
        const ctx = document.getElementById('allocation-types').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(memoryData.allocation_types),
                datasets: [{
                    data: Object.values(memoryData.allocation_types),
                    backgroundColor: [
                        'rgb(153, 102, 255)',
                        'rgb(255, 159, 64)',
                        'rgb(75, 192, 192)',
                        'rgb(54, 162, 235)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });
    }
    
    function drawHeatmap() {
        const canvas = document.getElementById('heatmap-canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Generate simulated heatmap data
        const cellWidth = 10;
        const cellHeight = 20;
        const cols = Math.floor(width / cellWidth);
        const rows = Math.floor(height / cellHeight);
        
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                // Simulate memory access frequency
                const intensity = Math.random() * Math.random(); // Bias towards lower values
                const color = getHeatmapColor(intensity);
                
                ctx.fillStyle = color;
                ctx.fillRect(col * cellWidth, row * cellHeight, cellWidth - 1, cellHeight - 1);
            }
        }
    }
    
    function getHeatmapColor(intensity) {
        // Blue -> Green -> Yellow -> Red gradient
        const r = Math.floor(255 * Math.min(intensity * 2, 1));
        const g = Math.floor(255 * (1 - Math.abs(intensity - 0.5) * 2));
        const b = Math.floor(255 * (1 - intensity));
        return `rgb(${r}, ${g}, ${b})`;
    }
    
    function drawEfficiencyChart() {
        const ctx = document.getElementById('efficiency-canvas').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: memoryData.efficiency.map(d => d.size),
                datasets: [{
                    label: 'Memory Usage (MB)',
                    data: memoryData.efficiency.map(d => d.memory),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    yAxisID: 'y',
                }, {
                    label: 'Efficiency Ratio',
                    data: memoryData.efficiency.map((d, i) => {
                        const sizeInMB = parseSize(d.size);
                        return (sizeInMB / d.memory).toFixed(2);
                    }),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    yAxisID: 'y1',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Input Size'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Memory (MB)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Efficiency Ratio'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
    
    function parseSize(sizeStr) {
        const match = sizeStr.match(/(\d+(?:\.\d+)?)\s*([KMG]B)/);
        if (!match) return 0;
        
        const value = parseFloat(match[1]);
        const unit = match[2];
        
        switch (unit) {
            case 'KB': return value / 1024;
            case 'MB': return value;
            case 'GB': return value * 1024;
            default: return value;
        }
    }
    
    function generateRecommendations() {
        const recommendations = [
            {
                severity: 'info',
                title: 'Memory Pool Optimization',
                description: 'Consider using memory pools for frequent small allocations (<1KB)'
            },
            {
                severity: 'success',
                title: 'Zero Memory Leaks',
                description: 'All allocations are properly deallocated. Great job!'
            },
            {
                severity: 'warning',
                title: 'Large Buffer Allocations',
                description: 'Consider streaming for files larger than 100MB to reduce peak memory'
            },
            {
                severity: 'info',
                title: 'Cache Efficiency',
                description: 'String deduplication could save ~15% memory for repetitive JSON keys'
            }
        ];
        
        const container = document.getElementById('recommendations');
        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation recommendation-${rec.severity}">
                <h4>${rec.title}</h4>
                <p>${rec.description}</p>
            </div>
        `).join('');
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', initMemoryProfiler);
})();
</script>